"use client";

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { CPALeadOffer } from '@/lib/cpa-lead-api';
import OffersListNew from '@/components/cpalead/OffersListNew';
import UserBalanceDisplay from '@/components/cpalead/UserBalanceDisplay';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Calendar, TrendingUp, Target, Gift, Globe, RefreshCw } from 'lucide-react';
import CountryFlag from '@/components/ui/CountryFlag';
import { toast } from 'sonner';
import OnboardingSlider from '@/components/dashboard/OnboardingSlider';
import WelcomeBonus from '@/components/dashboard/WelcomeBonus';
import AdBlock from '@/components/ui/AdBlock';
import { useElementVisibility } from '@/hooks/useElementVisibility';
import SeasonalThemeEffects from '@/components/themes/SeasonalThemeEffects';
import DailyMessage from '@/components/dashboard/DailyMessage';
import { useSeasonalTheme } from '@/hooks/useSeasonalTheme';

// Importar estilos de animaciones
import "./animations.css";

interface UserStats {
  balance: number;
  totalEarnings: number;
  todayEarnings: number;
  weekEarnings: number;
  totalTransactions: number;
  welcomeBonusClaimed?: boolean;
}

export default function DashboardPage() {
  const { user } = useAuth();
  const router = useRouter();
  const { activeTheme } = useSeasonalTheme();
  
  // Hook de visibilidad para elementos del dashboard
  const { isVisible, elements, isLoading } = useElementVisibility('dashboard');
  
  // Debug: Ver estado del hook
  useEffect(() => {
    console.log('üîç Dashboard - Estado de visibilidad:', {
      isLoading,
      elements,
      welcome_bonus: isVisible('welcome_bonus'),
      balance_display: isVisible('balance_display'),
      video_tutorial: isVisible('video_tutorial'),
      stat_today: isVisible('stat_today')
    });
  }, [elements, isLoading]);
  
  // Estado para controlar si se muestra el reproductor completo
  const [showFullPlayer, setShowFullPlayer] = useState(false);
  
  // Estado para el video tutorial
  const [tutorialVideo, setTutorialVideo] = useState({
    sliderUrl: '/video/tutorial-bienvenida.mp4',
    playerUrl: '/video/tutorial-bienvenida.mp4',
    title: 'Video tutorial',
    description: 'Aprende c√≥mo ganar dinero en Flasti',
    isClickable: true
  });
  
  const [offers, setOffers] = useState<CPALeadOffer[]>([]);
  const [userStats, setUserStats] = useState<UserStats>({
    balance: 0,
    totalEarnings: 0,
    todayEarnings: 0,
    weekEarnings: 0,
    totalTransactions: 0,
    welcomeBonusClaimed: false
  });
  const [isLoadingOffers, setIsLoadingOffers] = useState(true);
  const [isLoadingStats, setIsLoadingStats] = useState(true);
  const [cpaLeadData, setCpaLeadData] = useState<{
    userCountry: string;
    refreshing: boolean;
    handleRefresh: () => void;
  } | null>(null);

  // Redirecci√≥n autom√°tica para cuenta admin
  useEffect(() => {
    if (user?.email === 'flasti.finanzas@gmail.com') {
      router.push('/dashboard/admin');
    }
  }, [user, router]);
  const [detectedCountry, setDetectedCountry] = useState<string>('--');
  const [currentDateTime, setCurrentDateTime] = useState({ date: '', time: '' });

  // Detectar y guardar pa√≠s del usuario en la base de datos
  useEffect(() => {
    const detectAndSaveCountry = async () => {
      if (!user) return;

      try {
        // 1. Primero intentar desde localStorage (m√°s r√°pido)
        const savedCountry = localStorage.getItem('userCountry');
        if (savedCountry && savedCountry !== 'GLOBAL' && savedCountry !== '--') {
          setDetectedCountry(savedCountry);
        }

        // 2. Verificar en paralelo si el usuario ya tiene pa√≠s en BD
        const profilePromise = supabase
          .from('user_profiles')
          .select('country')
          .eq('user_id', user.id)
          .single();

        // 3. Si no hay en localStorage, detectar v√≠a API inmediatamente
        let countryCode = savedCountry && savedCountry !== 'GLOBAL' && savedCountry !== '--' ? savedCountry : null;
        
        if (!countryCode) {
          // Detectar pa√≠s con timeout para no bloquear
          const detectCountry = async () => {
            try {
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 segundos timeout
              
              const response = await fetch('https://ipapi.co/json/', {
                signal: controller.signal
              });
              clearTimeout(timeoutId);
              
              if (response.ok) {
                const data = await response.json();
                return data.country_code;
              }
            } catch (error) {
              console.warn('Error detectando pa√≠s v√≠a API:', error);
            }
            return null;
          };

          countryCode = await detectCountry();
          
          if (countryCode) {
            setDetectedCountry(countryCode);
            localStorage.setItem('userCountry', countryCode);
          }
        }

        // 4. Verificar resultado de BD
        const { data: profile } = await profilePromise;
        
        // Si BD tiene pa√≠s y es diferente al detectado, usar el de BD
        if (profile?.country && profile.country !== countryCode) {
          setDetectedCountry(profile.country);
          localStorage.setItem('userCountry', profile.country);
          countryCode = profile.country;
        }

        // 5. Guardar en BD si es necesario (en background)
        if (countryCode && (!profile?.country || profile.country !== countryCode)) {
          const deviceType = /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) 
            ? 'Mobile' 
            : /Tablet|iPad/i.test(navigator.userAgent)
            ? 'Tablet'
            : 'Desktop';

          // No esperar esta operaci√≥n
          supabase
            .from('user_profiles')
            .update({ 
              country: countryCode,
              device_type: deviceType
            })
            .eq('user_id', user.id)
            .then(() => console.log(`‚úÖ Pa√≠s guardado: ${countryCode} - ${deviceType}`))
            .catch(err => console.error('Error guardando pa√≠s:', err));
        }
      } catch (error) {
        console.error('Error detectando/guardando pa√≠s:', error);
        // Fallback: mantener el valor actual o usar '--'
        if (!detectedCountry || detectedCountry === '--') {
          const fallback = localStorage.getItem('userCountry');
          if (fallback && fallback !== 'GLOBAL') {
            setDetectedCountry(fallback);
          }
        }
      }
    };

    detectAndSaveCountry();
  }, [user]);

  // Actualizar fecha y hora cada minuto
  useEffect(() => {
    const updateDateTime = () => {
      const now = new Date();
      
      // Formatear fecha
      const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      
      const dayName = days[now.getDay()];
      const day = now.getDate();
      const monthName = months[now.getMonth()];
      
      // Formatear hora
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      
      setCurrentDateTime({
        date: `${dayName} ${day} ${monthName}`,
        time: `${hours}:${minutes}`
      });
    };

    updateDateTime();
    const interval = setInterval(updateDateTime, 60000);
    return () => clearInterval(interval);
  }, []);

  // Funci√≥n para obtener el nombre completo del pa√≠s
  const getCountryName = (code: string) => {
    if (!code || code === '--' || code === 'GLOBAL') return '';
    try {
      const regionNames = new Intl.DisplayNames(['es'], { type: 'region' });
      return regionNames.of(code);
    } catch (e) {
      return '';
    }
  };

  // Obtener ofertas de CPALead con filtrado por pa√≠s
  const fetchOffers = async (forceRefresh = false) => {
    try {
      setIsLoadingOffers(true);
      
      // Obtener pa√≠s del usuario desde localStorage
      const userCountry = localStorage.getItem('userCountry');
      
      // Construir URL con par√°metros
      const params = new URLSearchParams();
      if (userCountry && userCountry !== 'GLOBAL') {
        params.append('country', userCountry);
      }
      if (forceRefresh) {
        params.append('refresh', 'true');
      }
      
      const url = `/api/cpalead/offers${params.toString() ? `?${params.toString()}` : ''}`;
      console.log('üîÑ Solicitando ofertas desde:', url);
      
      const response = await fetch(url);
      const result = await response.json();
      
      if (result.success) {
        setOffers(result.data);
        console.log(`‚úÖ CPALead: Cargadas ${result.count} ofertas para ${result.requestedCountry || 'detecci√≥n autom√°tica'}`);
        
        if (result.stats) {
          console.log('üìä Estad√≠sticas de ofertas:', result.stats);
        }
      } else {
        console.error('‚ùå Error fetching CPALead offers:', result.message);
        toast.error('Error al cargar las ofertas');
        setOffers([]);
      }
    } catch (error) {
      console.error('‚ùå Error fetching CPALead offers:', error);
      toast.error('Error al cargar las ofertas');
      setOffers([]);
    } finally {
      setIsLoadingOffers(false);
    }
  };

  // Obtener estad√≠sticas del usuario
  const fetchUserStats = async () => {
    if (!user?.id) return;

    try {
      setIsLoadingStats(true);

      // Obtener el token de sesi√≥n actual
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        console.error('No hay sesi√≥n activa');
        return;
      }

      // Usar el endpoint de perfil de usuario con autorizaci√≥n
      const response = await fetch('/api/user/profile', {
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      if (data.error) {
        console.error('Error fetching user profile:', data.error);
        return;
      }

      const { profile, cpalead_stats } = data;

      const stats: UserStats = {
        balance: profile.balance || 0,
        totalEarnings: cpalead_stats.total_earnings || 0,
        todayEarnings: cpalead_stats.today_earnings || 0,
        weekEarnings: cpalead_stats.week_earnings || 0,
        totalTransactions: cpalead_stats.total_transactions || 0,
        welcomeBonusClaimed: profile.welcome_bonus_claimed || false
      };

      setUserStats(stats);

    } catch (error) {
      console.error('Error fetching user stats:', error);
    } finally {
      setIsLoadingStats(false);
    }
  };

  // Cargar video tutorial desde Supabase en tiempo real
  useEffect(() => {
    const loadTutorialVideo = async () => {
      try {
        const { data, error } = await supabase
          .from('tutorial_video')
          .select('*')
          .eq('is_active', true)
          .single();

        if (error) {
          console.error('Error al cargar video:', error);
        } else if (data) {
          console.log('üìπ Video cargado:', data);
          setTutorialVideo({
            sliderUrl: data.slider_video_url,
            playerUrl: data.player_video_url,
            title: data.title,
            description: data.description,
            isClickable: data.is_clickable
          });
        }
      } catch (error) {
        console.error('Error:', error);
      }
    };

    loadTutorialVideo();

    // Suscribirse a cambios en tiempo real
    const channel = supabase
      .channel('tutorial_video_changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'tutorial_video'
        },
        (payload) => {
          console.log('üìπ Video actualizado en tiempo real:', payload);
          loadTutorialVideo();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  // Cargar datos al montar el componente
  useEffect(() => {
    fetchOffers();
    fetchUserStats();
  }, [user?.id]);

  // Recargar ofertas cuando se detecte o cambie el pa√≠s del usuario
  useEffect(() => {
    const handleCountryChange = () => {
      const currentCountry = localStorage.getItem('userCountry');
      if (currentCountry && currentCountry !== 'GLOBAL') {
        console.log('üåç Pa√≠s detectado/cambiado, recargando ofertas para:', currentCountry);
        fetchOffers(true); // Force refresh
      }
    };

    // Escuchar cambios en localStorage
    window.addEventListener('storage', handleCountryChange);
    
    // Tambi√©n verificar peri√≥dicamente si se detect√≥ el pa√≠s
    const countryCheckInterval = setInterval(() => {
      const currentCountry = localStorage.getItem('userCountry');
      if (currentCountry && currentCountry !== 'GLOBAL' && offers.length === 0) {
        console.log('üîÑ Pa√≠s disponible, recargando ofertas...');
        fetchOffers();
      }
    }, 5000); // Verificar cada 5 segundos

    return () => {
      window.removeEventListener('storage', handleCountryChange);
      clearInterval(countryCheckInterval);
    };
  }, [offers.length]);

  // Configurar actualizaci√≥n en tiempo real del saldo
  useEffect(() => {
    if (!user?.id) return;

    const channel = supabase
      .channel('dashboard_updates')
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'user_profiles',
        filter: `user_id=eq.${user.id}`
      }, () => {
        fetchUserStats();
      })
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'cpalead_transactions',
        filter: `user_id=eq.${user.id}`
      }, () => {
        fetchUserStats();
        toast.success('¬°Nueva ganancia registrada!');
      })
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user?.id]);

  // Actualizar el pa√≠s detectado cuando cambien los datos de CPA Lead
  useEffect(() => {
    if (cpaLeadData) {
      setDetectedCountry(cpaLeadData.userCountry);
    }
  }, [cpaLeadData]);

  return (
    <div className="min-h-screen overscroll-none relative bg-[#0B1017]">
      
      {/* Efectos tem√°ticos estacionales */}
      <SeasonalThemeEffects />

      {/* Container principal con mejor padding y max-width */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 lg:py-6 pb-16 md:pb-8 relative z-10">
        
        {/* Bono de bienvenida m√≥vil - Fuera del contenedor - Controlable */}
        {user?.id && isVisible('welcome_bonus') && (
          <div className="md:hidden mb-4">
            <WelcomeBonus 
              userId={user.id} 
              onBonusClaimed={() => {
                toast.success('¬°Bono acreditado exitosamente!');
                fetchUserStats();
              }}
            />
          </div>
        )}

        {/* Contenedor m√≥vil con imagen de fondo - Balance y Video */}
        {user?.id && (
          <div 
            className="md:hidden mb-4 rounded-2xl overflow-hidden p-4 pb-6"
            style={{
              backgroundImage: activeTheme === 'halloween' 
                ? 'url(/images/fondo-halloween.webp)' 
                : activeTheme === 'christmas'
                ? 'url(/images/fondo-navidad.webp)'
                : 'url(/images/fondo.webp)',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          >
            {/* Balance y Mensaje del D√≠a - Grid 50/50 en todas las resoluciones */}
            <div className="grid grid-cols-2 gap-2 sm:gap-4 mb-4">
              {/* Balance - Controlable */}
              {isVisible('balance_display') && (
                <div className="h-full">
                  <UserBalanceDisplay
                    initialBalance={userStats.balance}
                    userId={user.id}
                    currency="USD"
                    showControls={true}
                  />
                </div>
              )}
              
              {/* Mensaje del D√≠a */}
              <div className="h-full">
                <DailyMessage />
              </div>
            </div>

            {/* Video Tutorial m√≥vil - Controlable */}
            {isVisible('video_tutorial') && (
              <div className="relative h-[200px] bg-black rounded-3xl overflow-hidden">
              <Card 
                className="relative bg-white/[0.03] backdrop-blur-2xl border border-white/10 hover:border-white/20 h-full overflow-hidden rounded-3xl transition-all duration-700 group"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent z-10"></div>
                {!showFullPlayer ? (
                  /* Video en bucle - Limpio */
                  <div 
                    className="relative w-full h-full cursor-pointer bg-black"
                    onClick={() => tutorialVideo.isClickable && setShowFullPlayer(true)}
                    onContextMenu={(e) => e.preventDefault()}
                  >
                    <video
                      className="w-full h-full object-contain"
                      autoPlay
                      loop
                      muted
                      playsInline
                      preload="auto"
                      controlsList="nodownload nofullscreen noremoteplayback"
                      disablePictureInPicture
                      key={tutorialVideo.sliderUrl}
                      onContextMenu={(e) => e.preventDefault()}
                    >
                      <source src={tutorialVideo.sliderUrl} type="video/mp4" />
                    </video>
                    
                    {/* Bot√≥n de play - Solo si es clickable */}
                    {tutorialVideo.isClickable && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowFullPlayer(true);
                        }}
                        className="absolute bottom-3 right-3 w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-all z-10"
                      >
                        <svg className="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="currentColor" viewBox="0 0 24 24" style={{marginLeft: '2px'}}>
                          <path d="M8 5v14l11-7z" />
                        </svg>
                      </button>
                    )}
                  </div>
                ) : (
                  /* Reproductor completo con controles */
                  <div className="relative w-full h-full bg-black" onContextMenu={(e) => e.preventDefault()}>
                    <video
                      className="w-full h-full object-contain"
                      controls
                      autoPlay
                      preload="metadata"
                      controlsList="nodownload noplaybackrate nofullscreen"
                      disablePictureInPicture
                      key={tutorialVideo.playerUrl}
                      onContextMenu={(e) => e.preventDefault()}
                    >
                      <source src={tutorialVideo.playerUrl} type="video/mp4" />
                      Tu navegador no soporta la reproducci√≥n de video.
                    </video>
                    
                    {/* Bot√≥n para volver al modo bucle */}
                    <button
                      onClick={() => setShowFullPlayer(false)}
                      className="absolute top-2 right-2 w-8 h-8 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-all z-10"
                      
                    >
                      <svg className="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                )}
              </Card>
            </div>
            )}
          </div>
        )}

        {/* Layout Desktop: Columna izquierda (Balance + Bono) y Columna derecha (Video) */}
        {user?.id && (
          <div 
            className="hidden md:block mb-4 lg:mb-6 rounded-2xl overflow-hidden py-6 px-4"
            style={{
              backgroundImage: activeTheme === 'halloween' 
                ? 'url(/images/fondo-halloween.webp)' 
                : activeTheme === 'christmas'
                ? 'url(/images/fondo-navidad.webp)'
                : 'url(/images/fondo.webp)',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          >
            <div className="grid md:grid-cols-2 gap-4">
            {/* Columna izquierda: Balance + Mensaje del D√≠a */}
            <div className="grid grid-cols-2 gap-4 h-[400px]">
              {/* Balance */}
              <div className="h-full">
                <UserBalanceDisplay
                  initialBalance={userStats.balance}
                  userId={user.id}
                  currency="USD"
                  showControls={true}
                />
              </div>

              {/* Mensaje del D√≠a */}
              <div className="h-full">
                <DailyMessage />
              </div>
            </div>

            {/* Columna derecha: Bono + Video Tutorial */}
            <div className="flex flex-col gap-4 h-[400px]">
              {/* Bono de bienvenida o AdBlock */}
              <div className="flex-shrink-0">
                {!userStats.welcomeBonusClaimed ? (
                  <WelcomeBonus 
                    userId={user.id} 
                    onBonusClaimed={() => {
                      toast.success('¬°Bono acreditado exitosamente!');
                      fetchUserStats();
                    }}
                  />
                ) : (
                  <div className="h-full flex items-center justify-center">
                    <AdBlock 
                      adClient="ca-pub-8330194041691289" 
                      adSlot="6796391562" 
                      alwaysVisible 
                      className="w-full max-w-full"
                    />
                  </div>
                )}
              </div>

              {/* Video Tutorial */}
              <div className="flex-1 min-h-0">
              <Card 
                className="relative bg-white/[0.03] backdrop-blur-2xl border border-white/10 hover:border-white/20 h-full overflow-hidden rounded-3xl transition-all duration-700 group"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent z-10"></div>
                {!showFullPlayer ? (
                  /* Video en bucle - Limpio */
                  <div 
                    className="relative w-full h-full cursor-pointer bg-black"
                    onClick={() => tutorialVideo.isClickable && setShowFullPlayer(true)}
                    onContextMenu={(e) => e.preventDefault()}
                  >
                    <video
                      className="w-full h-full object-contain"
                      autoPlay
                      loop
                      muted
                      playsInline
                      preload="auto"
                      controlsList="nodownload nofullscreen noremoteplayback"
                      disablePictureInPicture
                      key={tutorialVideo.sliderUrl}
                      onContextMenu={(e) => e.preventDefault()}
                    >
                      <source src={tutorialVideo.sliderUrl} type="video/mp4" />
                    </video>
                    
                    {/* Bot√≥n de play - Solo si es clickable */}
                    {tutorialVideo.isClickable && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowFullPlayer(true);
                        }}
                        className="absolute bottom-3 right-3 w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-all z-10"
                      >
                        <svg className="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="currentColor" viewBox="0 0 24 24" style={{marginLeft: '2px'}}>
                          <path d="M8 5v14l11-7z" />
                        </svg>
                      </button>
                    )}
                  </div>
                ) : (
                  /* Reproductor completo con controles */
                  <div className="relative w-full h-full bg-black" onContextMenu={(e) => e.preventDefault()}>
                    <video
                      className="w-full h-full object-contain"
                      controls
                      autoPlay
                      preload="metadata"
                      controlsList="nodownload noplaybackrate nofullscreen"
                      disablePictureInPicture
                      key={tutorialVideo.playerUrl}
                      onContextMenu={(e) => e.preventDefault()}
                    >
                      <source src={tutorialVideo.playerUrl} type="video/mp4" />
                      Tu navegador no soporta la reproducci√≥n de video.
                    </video>
                    
                    {/* Bot√≥n para volver al modo bucle */}
                    <button
                      onClick={() => setShowFullPlayer(false)}
                      className="absolute top-2 right-2 w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-all z-10"
                      
                    >
                      <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                )}
              </Card>
              </div>
            </div>
            </div>
          </div>
        )}

        {/* Estad√≠sticas con estilo glassmorphism exclusivo */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-4 lg:mb-6">
          {isVisible('stat_today') && (
            <div className="relative group">
              {/* Gradiente radial de fondo al hover */}
              <div 
                className="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700 blur-2xl"
                style={{ background: 'radial-gradient(circle at 50% 50%, rgba(255, 20, 147, 0.4), transparent 70%)' }}
              ></div>
              
              {/* Tarjeta glassmorphism */}
              <div 
                className="relative bg-white/[0.03] backdrop-blur-2xl rounded-3xl p-4 lg:p-6 border border-white/10 hover:border-white/20 transition-all duration-700 overflow-hidden group-hover:scale-[1.02]"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Efecto ne√≥n interno al hover */}
                <div 
                  className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"
                  style={{ boxShadow: 'inset 0 0 60px rgba(255, 20, 147, 0.4), 0 0 40px rgba(255, 20, 147, 0.4)' }}
                ></div>
                
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                
                {/* Contenido */}
                <div className="relative z-10">
                  <div className="flex items-center justify-between">
                    <div className="space-y-2">
                      <p className="text-xs font-medium text-white/60 uppercase tracking-wider">
                        <span className="hidden md:inline">Ganancias de </span>Hoy
                      </p>
                      <p className="text-2xl lg:text-3xl font-bold text-white">
                        ${userStats.todayEarnings.toFixed(2)}
                      </p>
                    </div>
                    <div className="relative p-3 rounded-xl bg-gradient-to-br from-[#FF1493]/20 to-[#FF1493]/5 group-hover:scale-110 transition-all duration-500">
                      <Calendar className="w-6 h-6 text-[#FF1493]" />
                    </div>
                  </div>
                </div>

                {/* Part√≠culas flotantes sutiles */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                  {[...Array(3)].map((_, idx) => (
                    <div
                      key={idx}
                      className="absolute w-1 h-1 rounded-full animate-float-particle"
                      style={{
                        background: '#FF1493',
                        left: `${20 + idx * 30}%`,
                        bottom: '10%',
                        animationDelay: `${idx * 0.5}s`,
                        boxShadow: '0 0 10px rgba(255, 20, 147, 0.4)'
                      }}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}

          {isVisible('stat_week') && (
            <div className="relative group">
              {/* Gradiente radial de fondo al hover */}
              <div 
                className="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700 blur-2xl"
                style={{ background: 'radial-gradient(circle at 50% 50%, rgba(45, 226, 230, 0.4), transparent 70%)' }}
              ></div>
              
              {/* Tarjeta glassmorphism */}
              <div 
                className="relative bg-white/[0.03] backdrop-blur-2xl rounded-3xl p-4 lg:p-6 border border-white/10 hover:border-white/20 transition-all duration-700 overflow-hidden group-hover:scale-[1.02]"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Efecto ne√≥n interno al hover */}
                <div 
                  className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"
                  style={{ boxShadow: 'inset 0 0 60px rgba(45, 226, 230, 0.4), 0 0 40px rgba(45, 226, 230, 0.4)' }}
                ></div>
                
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                
                {/* Contenido */}
                <div className="relative z-10">
                  <div className="flex items-center justify-between">
                    <div className="space-y-2">
                      <p className="text-xs font-medium text-white/60 uppercase tracking-wider">Esta Semana</p>
                      <p className="text-2xl lg:text-3xl font-bold text-white">
                        ${userStats.weekEarnings.toFixed(2)}
                      </p>
                    </div>
                    <div className="relative p-3 rounded-xl bg-gradient-to-br from-[#2DE2E6]/20 to-[#2DE2E6]/5 group-hover:scale-110 transition-all duration-500">
                      <TrendingUp className="w-6 h-6 text-[#2DE2E6]" />
                    </div>
                  </div>
                </div>

                {/* Part√≠culas flotantes sutiles */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                  {[...Array(3)].map((_, idx) => (
                    <div
                      key={idx}
                      className="absolute w-1 h-1 rounded-full animate-float-particle"
                      style={{
                        background: '#2DE2E6',
                        left: `${20 + idx * 30}%`,
                        bottom: '10%',
                        animationDelay: `${idx * 0.5}s`,
                        boxShadow: '0 0 10px rgba(45, 226, 230, 0.4)'
                      }}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}

          {isVisible('stat_total') && (
            <div className="relative group">
              {/* Gradiente radial de fondo al hover */}
              <div 
                className="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700 blur-2xl"
                style={{ background: 'radial-gradient(circle at 50% 50%, rgba(30, 144, 255, 0.4), transparent 70%)' }}
              ></div>
              
              {/* Tarjeta glassmorphism */}
              <div 
                className="relative bg-white/[0.03] backdrop-blur-2xl rounded-3xl p-4 lg:p-6 border border-white/10 hover:border-white/20 transition-all duration-700 overflow-hidden group-hover:scale-[1.02]"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Efecto ne√≥n interno al hover */}
                <div 
                  className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"
                  style={{ boxShadow: 'inset 0 0 60px rgba(30, 144, 255, 0.4), 0 0 40px rgba(30, 144, 255, 0.4)' }}
                ></div>
                
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                
                {/* Contenido */}
                <div className="relative z-10">
                  <div className="flex items-center justify-between">
                    <div className="space-y-2">
                      <p className="text-xs font-medium text-white/60 uppercase tracking-wider">Total Ganado</p>
                      <p className="text-2xl lg:text-3xl font-bold text-white">
                        ${userStats.totalEarnings.toFixed(2)}
                      </p>
                    </div>
                    <div className="relative p-3 rounded-xl bg-gradient-to-br from-[#8B5CF6]/20 to-[#8B5CF6]/5 group-hover:scale-110 transition-all duration-500">
                      <Target className="w-6 h-6 text-[#8B5CF6]" />
                    </div>
                  </div>
                </div>

                {/* Part√≠culas flotantes sutiles */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                  {[...Array(3)].map((_, idx) => (
                    <div
                      key={idx}
                      className="absolute w-1 h-1 rounded-full animate-float-particle"
                      style={{
                        background: '#1E90FF',
                        left: `${20 + idx * 30}%`,
                        bottom: '10%',
                        animationDelay: `${idx * 0.5}s`,
                        boxShadow: '0 0 10px rgba(30, 144, 255, 0.4)'
                      }}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}

          {isVisible('stat_completed') && (
            <div className="relative group">
              {/* Gradiente radial de fondo al hover */}
              <div 
                className="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700 blur-2xl"
                style={{ background: 'radial-gradient(circle at 50% 50%, rgba(255, 107, 53, 0.4), transparent 70%)' }}
              ></div>
              
              {/* Tarjeta glassmorphism */}
              <div 
                className="relative bg-white/[0.03] backdrop-blur-2xl rounded-3xl p-4 lg:p-6 border border-white/10 hover:border-white/20 transition-all duration-700 overflow-hidden group-hover:scale-[1.02]"
                style={{ boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)' }}
              >
                {/* Efecto ne√≥n interno al hover */}
                <div 
                  className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"
                  style={{ boxShadow: 'inset 0 0 60px rgba(255, 107, 53, 0.4), 0 0 40px rgba(255, 107, 53, 0.4)' }}
                ></div>
                
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                
                {/* Contenido */}
                <div className="relative z-10">
                  <div className="flex items-center justify-between">
                    <div className="space-y-2">
                      <p className="text-xs font-medium text-white/60 uppercase tracking-wider">
                        Completadas
                      </p>
                      <p className="text-2xl lg:text-3xl font-bold text-white">
                        {userStats.totalTransactions}
                      </p>
                    </div>
                    <div className="relative p-3 rounded-xl bg-gradient-to-br from-[#FF6B35]/20 to-[#FF6B35]/5 group-hover:scale-110 transition-all duration-500">
                      <Gift className="w-6 h-6 text-[#FF6B35]" />
                    </div>
                  </div>
                </div>

                {/* Part√≠culas flotantes sutiles */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                  {[...Array(3)].map((_, idx) => (
                    <div
                      key={idx}
                      className="absolute w-1 h-1 rounded-full animate-float-particle"
                      style={{
                        background: '#FF6B35',
                        left: `${20 + idx * 30}%`,
                        bottom: '10%',
                        animationDelay: `${idx * 0.5}s`,
                        boxShadow: '0 0 10px rgba(255, 107, 53, 0.4)'
                      }}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Contenido principal con tabs mejorado - Controlable */}
        {isVisible('offers_section') && (
          <Tabs defaultValue="offers" className="space-y-4">

            <TabsContent value="offers" className="space-y-4">
              <Card 
                className="relative bg-white/[0.03] backdrop-blur-2xl border border-white/10 rounded-3xl"
              >
                {/* Brillo superior glassmorphism */}
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
              <CardHeader className="pb-4">
                {/* T√≠tulo */}
                <div className="mb-3">
                  <CardTitle className="font-bold text-white">
                    <span className="text-lg md:text-2xl">Microtareas asignadas para ti hoy</span>
                  </CardTitle>
                  <CardDescription className="text-xs md:text-sm text-gray-400 mt-1">
                    Las tareas se actualizan autom√°ticamente, revise peri√≥dicamente para acceder a nuevas oportunidades de ingresos
                  </CardDescription>
                </div>
                
                {/* Controles debajo del t√≠tulo */}
                <div className="flex items-center justify-between">
                  {/* Badge de ubicaci√≥n - Solo m√≥vil (izquierda) */}
                  <div className="flex md:hidden">
                    {detectedCountry && detectedCountry !== '--' && detectedCountry !== 'GLOBAL' ? (
                      <div className="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-[#101010] shadow-sm whitespace-nowrap">
                        <CountryFlag countryCode={detectedCountry} size="sm" />
                        <span className="text-white font-semibold text-[10px]">
                          {detectedCountry}
                        </span>
                        <span className="text-white/40 text-[10px]">‚Ä¢</span>
                        <span className="text-white/70 text-[10px]">
                          {currentDateTime.date}
                        </span>
                      </div>
                    ) : (
                      <div className="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-md bg-[#101010] shadow-sm">
                        <span className="text-white/50 text-[10px]">Detectando...</span>
                      </div>
                    )}
                  </div>

                  {/* Bot√≥n actualizar - Desktop izquierda, M√≥vil derecha */}
                  <div className="flex md:ml-0 ml-auto">
                    {/* Bot√≥n escritorio */}
                    <button 
                      className="hidden md:flex items-center space-x-2 px-4 py-2 text-sm bg-white text-black rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50"
                      disabled={!cpaLeadData || cpaLeadData.refreshing}
                      onClick={cpaLeadData?.handleRefresh}
                    >
                      <RefreshCw className={`w-4 h-4 ${cpaLeadData?.refreshing ? 'animate-spin' : ''}`} />
                      <span>{cpaLeadData?.refreshing ? 'Actualizando...' : 'Actualizar'}</span>
                    </button>
                    
                    {/* Bot√≥n m√≥vil */}
                    <button 
                      className="flex md:hidden items-center space-x-2 px-3 py-1.5 text-xs bg-white text-black rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50"
                      disabled={!cpaLeadData || cpaLeadData.refreshing}
                      onClick={cpaLeadData?.handleRefresh}
                    >
                      <RefreshCw className={`w-3 h-3 ${cpaLeadData?.refreshing ? 'animate-spin' : ''}`} />
                      <span>{cpaLeadData?.refreshing ? 'Actualizando...' : 'Actualizar'}</span>
                    </button>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="pt-0">
                {isLoadingOffers ? (
                  <div className="flex flex-col items-center justify-center py-16 space-y-4">
                    <div className="relative">
                      <div className="w-16 h-16 rounded-full border-4 border-gray-700 flex items-center justify-center">
                        <div className="w-12 h-12 rounded-full border-4 border-gray-600 flex items-center justify-center">
                          <div className="w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-blue-500 flex items-center justify-center">
                            <div className="w-4 h-4 bg-white rounded-sm transform rotate-45"></div>
                          </div>
                        </div>
                      </div>
                      <div className="absolute inset-0 rounded-full border-4 border-transparent border-t-blue-500 animate-spin"></div>
                    </div>
                    <p className="text-gray-400 font-medium">Cargando microtareas...</p>
                  </div>
                ) : (
                  <OffersListNew onDataUpdate={setCpaLeadData} />
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
        )}
      </div>
    </div>
  );
}
